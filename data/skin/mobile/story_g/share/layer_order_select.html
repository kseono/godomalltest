{*** 주문 선택하기 레이어 | share/layer_order_select.php ***}

<div class="ly_head">
    <h1 class="h_tit elp">{=__('주문내역')}</h1>
</div>
<div class="ly_ct" style="background-color: #ffffff;height:100%;overflow: scroll">
    <form id="frmBoardSearch" name="frmBoardSearch" onsubmit="return false">
        <div class="ly_buy_info">
            <ul class="ly_opt">
                <li class="js-singel-option">
                    <div class="search-box" style="background-color: #ffffff">
                        <div class="search-filter">
                            <div class="inp_sel">
                                <select name="key" id="key" class="tune">
                                    <option value="o.orderNo">{=__('주문번호')}</option>
                                    <option value="og.goodsNm">{=__('상품명')}</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-text">
                            <input type="text" name="keyword">
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="block-pd">
            <button class="btn btn_g1 btn-w js-select-search" type="button">{=__('검색')}</button>
        </div>
    </form>
    <div class="temp-loop">
        <div class="orderlist-wrap" id="ajaxSearchResult">
        </div>
    </div>
    <div class="block-pd more-btn" style="height:100px">
        <button type="button" class="more-btn btn-gray btn-w btn js-paging-more" data-page="1" >{=__('더보기')}</button>
    </div>
</div>
<script>
    $(document).ready(function () {
        /**
         * 주문선택팝업
         */
        $('input[name=keyword]').keyup(function(e){
            if(e.keyCode == 13) {
                $('.js-select-search').trigger('click');
            }
        })

        $('.js-select-search').bind('click',function(e){
            params = $("#frmBoardSearch").serialize();
            $.ajax({
                method: "get",
                url: "../share/layer_order_search.php",
                data: params,
                dataType: 'text'
            }).success(function (data) {
                $('#ajaxSearchResult').html(data);
                $('.js-paging-more').data('page',1);
            }).error(function (e) {
                alert(e.responseText);
            });
        })

        /**
         * 더보기버튼 클릭
         */
        $('.js-paging-more').bind('click',function(){
            if($('#ajaxSearchResult ul.my_goods>li').length<1) {
                alert("{=__('데이터가 없습니다.')}");
                return;
            }
            var page = $(this).data('page')+1;
            params = $("#frmBoardSearch").serialize()+'&page='+page;
            $.ajax({
                method: "get",
                url: "../share/layer_order_search.php",
                data: params,
                dataType: 'text'
            }).success(function (data) {
                console.log(data);
                if(data == '') {
                    alert("{=__('주문이 없습니다.')}");
                    return;
                }
                $('#ajaxSearchResult').append(data);
                $('.js-paging-more').data('page',page);
            }).error(function (e) {
                alert(e.responseText);
            });
        })
    });
    $('.js-select-search').trigger('click');

    /**
     * 주문선택
     */
    $('#ajaxSearchResult').on('click','.js-select-confirm',function(e){
        var selectObj = $(this).closest('.my_goods');
        var orderDuplication = '{orderDuplication}';
        var bdId ='{bdId}';
        var bdSno ='{bdSno}';
        var checkedOrderGoodsNo = selectObj.data('ordergoodsno');
        var canFlag = true;
        var mode = null;

        if(bdId == 'goodsreview') {
            mode = 'validRegistOrderGoodsNo';
        }
        else if(orderDuplication == 'n'){
            mode = 'duplicateOrderGoodsNo';
        }

        if(mode !== null) {
            $.ajax({
                method: "post",
                async : false,
                url: "../board/board_ps.php",
                data: {mode : mode,bdId : bdId , orderGoodsNo : checkedOrderGoodsNo, bdSno : bdSno},
                dataType: 'text'
            }).success(function (data) {
                if (data != 'n') {
                    alert('선택하신 주문은 이미 작성 되었습니다. 다른 주문을 선택하여 주시기 바랍니다.');
                    canFlag = false;
                }
                console.log(data);
            }).error(function (e) {
                alert(e.responseText);
            });
        }
        if(canFlag == false) {
            return false;
        }
        var resultJson = {
            "info": []
        };

        var imgSrc = selectObj.find('.thmb img').attr('src');
        var goodsName = selectObj.find('.goods-name').text();
        var optionName = selectObj.find('.goods-option').text();
        var price = selectObj.find('.goods-price').text();
        var orderNo = selectObj.find('input[name=orderNo]').val();
        var goodsNo = selectObj.find('input[name=goodsNo]').val();
        var status = selectObj.find('.status').text();

        resultJson.info.push({
            "orderNo" : orderNo,
            "orderGoodsNo": checkedOrderGoodsNo,
            "goodsImgageSrc": imgSrc,
            "goodsName": goodsName,
            "optionName": optionName,
            "goodsPrice": price,
            "goodsNo" :goodsNo ,
            "status" : status,
        });

        console.log(resultJson);
        setAddOrder(resultJson);
        $('.js-layer-close').trigger('click');
    })
</script>
<button type="button" class="bn_cls v2 ly_btn_close js-layer-close"><span class="sp">{=__('닫기')}</span></button>

