{*** 상품 선택하기 레이어 | share/layer_goods_select.php ***}
<div class="ly_head">
    <h1 class="h_tit elp">{=__('상품 검색')}</h1>
</div>
<div class="ly_ct" style="background-color: #ffffff;height:100%;overflow: scroll">
    <form id="frmBoardSearch" name="frmBoardSearch" onsubmit="return false">
        <input type="hidden" name="isPlusReview" value="{isPlusReview}" />
        <div class="ly_buy_info">
            <ul class="ly_opt">
                <li class="js-singel-option">
                    <div class="search-box">
                        <div class="search-filter">
                            <div class="inp_sel">
                                <select name="key" onchange="get_list(1,true);">
                                    <option value="goodsNm">{=__('상품명')}</option>
                                    <option value="goodsNo">{=__('상품코드')}</option>
                                </select>
                            </div>
                        </div>
                        <div class="search-text">
                            <input type="text" name="keyword" placeholder="{=__('검색어를 입력해주세요.')}">
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="block-pd">
            <button class="btn btn_g1 btn-w js-select-search" type="button">{=__('검색')}</button>
        </div>
    </form>
    <div class="temp-loop" id="ajaxSearchResult"></div>
    <div class="block-pd more-btn js-more-btn" style="height:100px;display: none">
        <button type="button" class="more-btn btn-gray btn-w btn js-paging-more" data-page="1"  >{=__('더보기')}</button>
    </div>

</div>
<script>
    $(document).ready(function () {
        /**
         * 주문선택팝업
         */
        $('input[name=keyword]').keyup(function(e){
            if(e.keyCode == 13) {
                $('.js-select-search').trigger('click');
            }
        })

        $('.js-select-search').bind('click',function(e){
            if ($('#frmBoardSearch input[name=keyword]').val().length < 1) {
                alert("{=__('검색어를 입력해주세요.')}");
                return;
            }
            params = $("#frmBoardSearch").serialize();
            console.log(params);
            $.ajax({
                method: "get",
                url: "../share/layer_goods_search.php",
                data: params,
                dataType: 'text'
            }).success(function (data) {
                $('.js-more-btn:hidden').show();
                $('#ajaxSearchResult').html(data);
                $('.js-paging-more').data('page',1);
            }).error(function (e) {
                alert(e.responseText);
            });
        })

        /**
         * 더보기버튼 클릭
         */
        $('.js-paging-more').bind('click',function(){
            if($('#ajaxSearchResult ul.my_goods>li').length<1) {
                alert("{=__('데이터가 없습니다.')}");
                return;
            }
            var page = $(this).data('page')+1;
            params = $("#frmBoardSearch").serialize()+'&page='+page;
            $.ajax({
                method: "get",
                url: "../share/layer_goods_search.php",
                data: params,
                dataType: 'text'
            }).success(function (data) {
                if(data == '') {
                    alert("{=__('더 이상 상품이 없습니다.')}");
                    return;
                }
                $('#ajaxSearchResult').append(data);
                $('.js-paging-more').data('page',page);
            }).error(function (e) {
                alert(e.responseText);
            });
        })
    });

    $('#ajaxSearchResult').on('click','.js-select-confirm',function(){
        var resultJson = {
            "info": []
        };

        var bdId = '{bdId}';
        var bdSno = '{bdSno}';
        var canFlag = true;
        var selectObj = $(this).closest('.my_goods');
        var checkedGoodsNo = selectObj.data('goodsno');
        var imgSrc = selectObj.find('.thmb.img>img').attr('src');
        var goodsName = selectObj.find('.itembody .elp2').text();
        var price = selectObj.find('.goods-price').text();

        resultJson.info.push({
            "goodsNo": checkedGoodsNo,
            "goodsImgageSrc": imgSrc,
            "goodsName": goodsName,
            "goodsPrice": price,
        });
        console.log(resultJson);

        if (bdId == 'goodsreview') {
            $.ajax({
                method: "post",
                async: false,
                url: "../board/board_ps.php",
                data: {mode: 'validRegistOrderGoodsNo', bdId: bdId, goodsNo: checkedGoodsNo, bdSno: bdSno},
                dataType: 'text'
            }).success(function (data) {
                if (data != 'n') {
                    alert('선택하신 상품은 후기를 작성하실 수 없습니다.');
                    canFlag = false;
                }
                console.log(data);
                return;
            }).error(function (e) {
                alert(e.responseText);
            });

            if (canFlag == false) {
                return false;
            }
        }
        setAddGoods(resultJson);
        $('.js-layer-close').trigger('click');
    })
</script>
<button type="button" class="bn_cls v2 ly_btn_close js-layer-close"><span class="sp">{=__('닫기')}</span></button>
