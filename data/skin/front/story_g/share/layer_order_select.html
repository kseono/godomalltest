{*** 주문 선택 레이어 | share/layer_order_select.php ***}
<div class="box goods-select-layer order layer-size-h-a">
    <div class="view">
        <h2> {=__('주문내역')}</h2>
        <div class="scroll-area">
            <form id="frmBoardSearch" name="frmBoardSearch">
                <div class="date-check">
                    <div class="date-check-row">
                        <div class="date-check-head">
                            <h3 class="h3">
                                {=__('조회기간')}
                            </h3>
                        </div>
                        <div class="date-check-body">
                            <div class="check-option clear">
                                <div class="check-option-inner" data-target-name="treatDate[]">
                                    <div class="btn">
                                        <button class="inner" type="button"  data-value="0">{=__('오늘')}</button>
                                    </div>
                                    <div class="btn active">
                                        <button class="inner" type="button" data-value="7">7{=__('일')}</button>
                                    </div>
                                    <div class="btn">
                                        <button class="inner" type="button"  data-value="15">15{=__('일')}</button>
                                    </div>
                                    <div class="btn">
                                        <button class="inner" type="button" data-value="30">1{=__('개월')}</button>
                                    </div>
                                    <div class="btn">
                                        <button class="inner" type="button" data-value="90">3{=__('개월')}</button>
                                    </div>
                                    <div class="btn">
                                        <button class="inner" type="button" data-value="365">1{=__('년')}</button>
                                    </div>
                                    <input type="hidden" name="periodFl" value="7">
                                </div>
                                <div id="layer" class="layer"></div>
                            </div>
                            <div class="check-cal">
                                <div class="cal-from">
                                    <input type="text" name="treatDate[]" value="" id="picker2" class="js-datepicker"/>
                                    <img class="icon-cal" src="../img/etc/icon-cal.png" alt="{=__('달력 아이콘')}"/>
                                </div>
                                <div class="divide">~</div>
                                <div class="cal-to">
                                    <input type="text" name="treatDate[]" value="" class="js-datepicker"/>
                                    <img class="icon-cal" src="../img/etc/icon-cal.png" alt="{=__('달력 아이콘')}"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="date-check-row">
                        <div class="date-check-head">
                            <h3 class="h3">
                                {=__('검색어')}
                            </h3>
                        </div>
                        <div class="date-check-body">
                            <div class="search-box1">
                                <div class="search-filter">
                                    <div class="choice-select">
                                        <select name="key" id="key" class="tune">
                                            <option value="o.orderNo">{=__('주문번호')}</option>
                                            <option value="og.goodsNm">{=__('상품명')}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="search-text">
                                    <div class="txt-field">
                                        <input type="text" class="text" name="keyword" maxlength="20" value="">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="date-check-submit">
                    <button type="button" class="skinbtn point2 cl-find js-select-search"><em>{=__('조회')} <img  src="\{=c.PATH_SKIN}img/etc/search.png"></em></button>
                </div>
            </form>
            <div id="ajaxSearchResult" style="padding:0px">
            </div>
        </div>
        <div class="btn">
            <button class="skinbtn point1 layer-close btn-close"><em>{=__('취소')}</em></button>
            <button id="btnAllCouponDown" class="skinbtn point2 btn-m js-select-confirm"><em>{=__('확인')}</em></button>
        </div>
        <button title="{=__('닫기')}" class="close" type="button">{=__('닫기')}</button>
    </div>
</div>
<script type="text/javascript" src="\{=c.PATH_SKIN}js/moment/moment.js"></script>
<script type="text/javascript" src="\{=c.PATH_SKIN}js/moment/locale/{=locale}.js"></script>
<script type="text/javascript" src="\{=c.PATH_SKIN}js/jquery/datetimepicker/bootstrap-datetimepicker.js"></script>
<link type="text/css" rel="stylesheet" href="\{=c.PATH_SKIN}css/plugins/bootstrap-datetimepicker.min.css" />
<link type="text/css" rel="stylesheet" href="\{=c.PATH_SKIN}css/plugins/bootstrap-datetimepicker-standalone.css" />
<script>
    $(document).ready(function () {
        /**
         * 주문조회클릭
         */
        $('input[name=keyword]').keyup(function(e){
            if(e.keyCode == 13) {
                $('.js-select-search').trigger('click');
            }
        })

        $('.js-select-search').bind('click', function (e) {
            params = $("#frmBoardSearch").serialize();
            $.ajax({
                method: "get",
                url: "../share/layer_order_search.php",
                data: params,
                dataType: 'text'
            }).success(function (data) {
                $('#ajaxSearchResult').html(data);
            }).error(function (e) {
                console.log(e.responseText);
            });
        })
        $('.js-select-search').trigger('click');
        $('.check-option-inner').find('button').bind('click',function(){
            $('input[name=periodFl]').val($(this).data('value'));
        })

        if ($('.js-datepicker').length>0) {
            $('.js-datepicker').datetimepicker({
                locale: '{=gGlobal.locale}',
                format: 'YYYY-MM-DD',
                dayViewHeaderFormat: 'YYYY MM',
                viewMode: 'days',
                ignoreReadonly: true,
                debug: false,

            });

            $('.check-cal img').click(function (e) {
                $(this).prev('.js-datepicker').data('DateTimePicker').show();
            });
            //날짜 체크 정규식 /^(19|20)\d{2}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[0-1])$/;
        }
        if ($('.check-option-inner').length>0) {
            $('.check-option-inner button.inner').click(function (e) {
                $startDate = $endDate = '';
                $period = $(this).data('value');
                $elements = $('input[name="' + $(this).closest('.check-option-inner').data('target-name') + '"]');
                $format = $($elements[0]).data('DateTimePicker').format();
                if ($period >= 0) {
                    $startDate = moment().hours(0).minutes(0).seconds(0).subtract($period, 'days').format($format);
                    $endDate = moment().hours(0).minutes(0).seconds(0).format($format);
                }
                $($elements[0]).val($startDate);
                $($elements[1]).val($endDate);

                $('.check-option-inner .btn').removeClass('active');
                $(this).parents('.btn').addClass('active');
            });
            // 선택된 버튼에 따른 값 초기화
            $elements = $('input[name*=\'' + $('.check-option-inner').data('target-name') + '\']');
            $('.check-option-inner .active').find('button').trigger('click');
        }

        /**
         * 주문선택
         */
        $('.js-select-confirm').bind('click',function(){
            if($('#frmSelect input[type=radio][name="orderGoodsNo[]"]:checked').length<1) {
                alert("{=__('주문을 선택해주세요.')}");
                return;
            }
            var orderDuplication = '{orderDuplication}';
            var bdId ='{bdId}';
            var bdSno ='{bdSno}';
            var checkedOrderGoodsNo = $('#frmSelect input[name="orderGoodsNo[]"]:checked').val();
            var canFlag = true;
            var mode = null;

            if(bdId == 'goodsreview') {
                mode = 'validRegistOrderGoodsNo';
            }
            else if(orderDuplication == 'n'){
               mode = 'duplicateOrderGoodsNo';
            }

            if(mode !== null) {
                $.ajax({
                    method: "post",
                    async : false,
                    url: "../board/board_ps.php",
                    data: {mode : mode,bdId : bdId , orderGoodsNo : checkedOrderGoodsNo, bdSno : bdSno},
                    dataType: 'text'
                }).success(function (data) {
                    if (data != 'n') {
                        alert('선택하신 주문은 이미 작성 되었습니다. 다른 주문을 선택하여 주시기 바랍니다.');
                        canFlag = false;
                    }
                    console.log(data);
                    return;
                }).error(function (e) {
                    alert(e.responseText);
                });
            }
            if(canFlag == false) {
                return false;
            }

            var resultJson = {
                "info": []
            };

            var imgSrc = $('#tbl_add_'+checkedOrderGoodsNo).find('.order-title .img img').attr('src');
            var goodsName = $('#tbl_add_'+checkedOrderGoodsNo).find('.goods-name').text();
            var optionName = $('#tbl_add_'+checkedOrderGoodsNo).find('.goods-option').text();
            var price = $('#tbl_add_'+checkedOrderGoodsNo).find('.goods-price').text();
            var orderNo = $('#tbl_add_'+checkedOrderGoodsNo).find('.item-orderNo').text();
            var goodsNo = $('#tbl_add_'+checkedOrderGoodsNo).find('input[name=goodsNo]').val();

            resultJson.info.push({
                "orderNo" : orderNo,
                "orderGoodsNo": checkedOrderGoodsNo,
                "goodsImgageSrc": imgSrc,
                "goodsName": goodsName,
                "optionName": optionName,
                "goodsPrice": price,
                "goodsNo" :goodsNo ,
            });

            setAddOrder(resultJson);
            closeLayer();
        })
    })

    function goAjaxPaging(page){
        $.ajax({
            method: "get",
            url: "../share/layer_order_search.php",
            data: page,
            dataType: 'text'
        }).success(function (data) {
            $('#ajaxSearchResult').html(data);
            console.log(data);
        }).error(function (e) {
            alert(e.responseText);
        });
    }
</script>
