{*** 배송지관리 리스트 | order/layer_shipping_address.php ***}

<div class="box delivery-layer">
    <div class="view">
        <h2>{=__('나의 배송지 관리')}</h2>
        <div class="tit">
            <h3>{=__('배송지 목록')}</h3>
            <a href="#deliveryAddLayer" class="btn-open-layer skinbtn base2 shipping-add"><em>+ {=__('새 배송지 추가')}</em></a>
        </div>
        <div class="table1">
            <table>
                <colgroup>
                    <col style="width:79px" />
                    <col style="width:75px" />
                    <col />
                    <col style="width:140px" />
                    <col style="width:87px" />
                </colgroup>
                <thead>
                <tr>
                    <th>{=__('배송지이름')}</th>
                    <th>{=__('받으실분')}</th>
                    <th>{=__('주 소')}</th>
                    <th>{=__('연락처')}</th>
                    <th>{=__('수정/삭제')}</th>
                </tr>
                </thead>
                <tbody>
                <!--{ ? deliveryAddress }-->
                <!--{ @ deliveryAddress }-->
                <tr data-shipping-name="{.shippingTitle}">
                    <input type="hidden" name="shippingName" value="{.shippingName}">
                    <input type="hidden" name="shippingCountryCode" value="{.shippingCountryCode}">
                    <input type="hidden" name="shippingZonecode" value="{.shippingZonecode}">
                    <input type="hidden" name="shippingZipcode" value="{.shippingZipcode}">
                    <input type="hidden" name="shippingCity" value="{.shippingCity}">
                    <input type="hidden" name="shippingState" value="{.shippingState}">
                    <input type="hidden" name="shippingAddress" value="{.shippingAddress}">
                    <input type="hidden" name="shippingAddressSub" value="{.shippingAddressSub}">
                    <input type="hidden" name="shippingPhonePrefixCode" value="{.shippingPhonePrefixCode}">
                    <input type="hidden" name="shippingPhonePrefix" value="{.shippingPhonePrefix}">
                    <input type="hidden" name="shippingPhone" value="{.shippingPhone}">
                    <input type="hidden" name="shippingCellPhonePrefixCode" value="{.shippingCellPhonePrefixCode}">
                    <input type="hidden" name="shippingCellPhonePrefix" value="{.shippingCellPhonePrefix}">
                    <input type="hidden" name="shippingCellPhone" value="{.shippingCellPhone}">
                    <td class="ta-c delivery-loc">
                        <a href="#" class="shipping-address">
                            <!--{ ? .defaultFl == 'y' }--><span>({=__('기본배송지')})</span><br /><!--{ / }-->
                            <b>{.shippingTitle}</b>
                        </a>
                    </td>
                    <td class="ta-c delivery-name">{.shippingName}</td>
                    <td class="delivery-address">
                        <!--{ ? gGlobal.isFront }-->
                        <span>({.shippingZonecode})</span>
                        <p>{.shippingAddressSub}, {.shippingAddress}, {.shippingState}, {.shippingCity}, {.shippingCountry}</p>
                        <!--{ : }-->
                        <span>({.shippingZonecode})</span>
                        <p>{.shippingAddress} {.shippingAddressSub}</p>
                        <!--{ / }-->
                    </td>
                    <td class="ta-c delivery-tel">
                        {=__('전화번호')} : <!--{ ? gGlobal.isFront }-->(+{.shippingPhonePrefix}) <!--{ / }-->{.shippingPhone} <br />
                        {=__('휴대폰')} : <!--{ ? gGlobal.isFront }-->(+{.shippingCellPhonePrefix}) <!--{ / }-->{.shippingCellPhone}
                    </td>
                    <td class="ta-c delivery-btn">
                        <button type="button" href="#deliveryAddLayer" class="normal-btn small1 btn-open-layer" data-sno="{.sno}"><em>{=__('수정')}</em></button>
                        <button type="button" href="#" class="normal-btn small1 js-delete" data-sno="{.sno}" data-default-fl="{=.defaultFl}"><em>{=__('삭제')}</em></button>
                    </td>
                </tr>
                <!--{ / }-->
                <!--{ : }-->
                <tr>
                    <td colspan="5" class="no-data">{=__('배송지 리스트가 없습니다.')}</td>
                </tr>
                <!--{ / }-->
                </tbody>
            </table>
        </div>
        {pagination}
        <button title="{=__('닫기')}" class="close" type="button">{=__('닫기')}</button>
    </div>
</div>

<!-- 새 배송지 추가 레이어 -->
<div id="deliveryAddLayer" class="layer-wrap dn"></div>
<!--//새 배송지 추가 레이어 -->

<script type="text/javascript">
    // DOM 로드
    $(function(){
        // 등록/수정 레이어 바인딩
        $('.delivery-layer .btn-open-layer').bind('click', function(e){
            var target = $(this).attr('href');
            if (target == '#deliveryAddLayer') {
                // 배송지 등록/수정 모드에 따른 파라미터 설정
                var param = '?';
                param += !_.isUndefined($(this).data('sno')) && $(this).data('sno') > 0 ? 'sno=' + $(this).data('sno') : '';
                param += '&shippingNo={=shippingNo}';

                // AJAX 호출
                $.get('../order/layer_shipping_address_regist.php' + param, function(data){
                    $('#myShippingListLayer').empty().append(data).find('>div').center();
                });
            }
        });

        // 배송지 클릭
        $('.shipping-address').click(function(e){
            insertShippingAddress($(this).closest('tr'));
            $('.delivery-layer .close').trigger('click');
            return false;
        });

        // 삭제하기
        $('.js-delete').click(function(e){
            if ($(this).data('default-fl') == 'y') {
                alert(__('기본 배송지는 삭제할 수 없습니다. 변경 후 삭제해주세요.'));
            } else {
                if (confirm('나의 배송지 [' + $(this).closest('tr').data('shipping-name') + ']을(를) 정말로 삭제하시겠습니까?')) {
                    var currentPage = $('.delivery-layer .pagination > li.active').text();
                    var params = {
                        sno: $(this).data('sno'),
                        mode: 'shipping_delete'
                    };
                    $.post('../order/layer_shipping_ps.php', params, function(data){
                        if(data.code == 200) {
                            goPageOnDeliveryAddress('page=' + currentPage + '&shippingNo={shippingNo}');
                        } else {
                            alert(data.message);
                            $('.delivery-add-layer .close').trigger('click');
                        }
                    });
                    return false;
                }
            }
        });
    });

    // 배송지관리 이벤트
    function goPageOnDeliveryAddress(page) {
        $.get('../order/layer_shipping_address.php?' + page + '&shippingNo={shippingNo}', function(data){
            $('#myShippingListLayer').empty().append(data);
            $('#myShippingListLayer').find('>div').center();
        });
    }

    // 배송지 클릭
    function insertShippingAddress(obj)
    {
        var params = {
            shippingName: obj.find('input[name=shippingName]:eq(0)').val(),
            shippingCountryCode: obj.find('input[name=shippingCountryCode]:eq(0)').val(),
            shippingZonecode: obj.find('input[name=shippingZonecode]:eq(0)').val(),
            shippingZipcode: obj.find('input[name=shippingZipcode]:eq(0)').val(),
            shippingCity: obj.find('input[name=shippingCity]:eq(0)').val(),
            shippingState: obj.find('input[name=shippingState]:eq(0)').val(),
            shippingAddress: obj.find('input[name=shippingAddress]:eq(0)').val(),
            shippingAddressSub: obj.find('input[name=shippingAddressSub]:eq(0)').val(),
            shippingPhonePrefixCode: obj.find('input[name=shippingPhonePrefixCode]:eq(0)').val(),
            shippingPhonePrefix: obj.find('input[name=shippingPhonePrefix]:eq(0)').val(),
            shippingPhone: obj.find('input[name=shippingPhone]:eq(0)').val(),
            shippingCellPhonePrefixCode: obj.find('input[name=shippingCellPhonePrefixCode]:eq(0)').val(),
            shippingCellPhonePrefix: obj.find('input[name=shippingCellPhonePrefix]:eq(0)').val(),
            shippingCellPhone: obj.find('input[name=shippingCellPhone]:eq(0)').val(),
        };
        set_delivery_shipping_address(params, '{=shippingNo}');
    }
</script>
